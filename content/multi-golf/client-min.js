const client={params:{match:function(e,t,n){const i=client.params.QUERY.match(new RegExp(["<",e,":(",t,")>"].join("")));if(i)return n(i[1])},matchString:function(e){return client.params.match(e,"[^>]*",game.utility.identity)},matchBoolean:function(e){return client.params.match(e,"false|true",(function(e){switch(e){case"false":return!1;case"true":return!0;default:throw new Error}}))},matchInteger:function(e){return client.params.match(e,"\\d+",(function(e){return parseInt(e)}))},matchFloat:function(e){return client.params.match(e,"\\d+\\.\\d+",(function(e){return parseFloat(e)}))},QUERY:decodeURIComponent(window.location.search)},network:{handlers:{lobby:{Main:function(e){this.connection=e},NameChanging:function(e,t){this.connection=e,this.form=t},SessionCreating:function(e,t){this.connection=e,this.form=t},SessionJoining:function(e,t,n){this.session=e,this.form=t,this.reference=n}},session:{Main:function(e,t){this.member=e,this.form=t,this.update()},Leaving:function(e,t){this.connection=e,this.form=t}},game:{Starting:function(e,t,n){this.launcher=e,this.course=t,this.callable=n},Main:function(e,t,n,i){this.session=e,this.course=t,this.state=n,this.cancel=i},Leaving:function(e){this.connection=e}},Registration:function(e,t){this.procedureSocket=e,this.form=t},Login:function(e,t){this.procedureSocket=e,this.form=t}},queues:{Instant:function(){},Delayed:function(e,t){this.minDelay=e,this.maxDelay=t,this.data=[]}},ProcedureSocket:function(e,t){this.socket=e,this.mapper=t,this.outQueue=client.network.queues.build(),this.inQueue=client.network.queues.build(),this.register()},Connection:function(e,t){this.procedureSocket=e,this.player=t},Session:function(e,t){this.connection=e,this.key=t},Member:function(e,t){this.session=e,this.idToPlayer=new Map([e.connection.player].concat(t).map((function(e){return[e.id,e]}))),game.utility.assert(this.idToPlayer.size==t.length+1,"Duplicate player IDs")},Launcher:function(e,t,n,i,r,o,a){this.session=e,this.reference=t,this.index=n,this.timestamp=i,this.totalTime=r,this.endTime=o,this.playerActions=a,this.queue=[]}},form:{utility:{singleElement:function(e){return game.utility.assert(1==e.length,"Not a single element"),e[0]},singleOfTag:(e,t)=>client.form.utility.singleElement(e.getElementsByTagName(t)),singleOfClass:(e,t)=>client.form.utility.singleElement(e.getElementsByClassName(t)),open:function(e){return e.enable(),e.show(),e},close:function(e,t){e.unregister(),e.disable(),e.hide(t)},transition:function(e,t){client.form.utility.close(e,(function(){client.form.utility.open(t)}))},fade:function(e,t,n){function i(){game.utility.assert(parseFloat(e.style.getPropertyValue("opacity"))==n,"Unexpected opacity value"),r(),t()}function r(){e.removeEventListener("transitionend",i),e.removeEventListener("transitioncancel",r)}t&&(e.addEventListener("transitionend",i),e.addEventListener("transitioncancel",r)),e.style.setProperty("opacity",n)},hide:function(e,t){client.form.utility.fade(e,(function(){e.style.setProperty("visibility","hidden"),t&&t()}),0)},show:function(e,t){e.style.setProperty("visibility","visible"),client.form.utility.fade(e,t,1)}},inputs:{playerName:function(e,t){return new client.form.Input(e,t,(function(e){if(!game.network.constraints.string.isPlayerName(e))return"1 to "+game.network.constraints.string.PLAYER_NAME_MAX_LENGTH+" characters from A-Z, a-z, 0-9 and _"}),game.network.constraints.string.PLAYER_NAME_MAX_LENGTH)},playerKey:function(e,t){return new client.form.Input(e,t,(function(e){if(!game.network.constraints.string.isPlayerKey(e))return game.network.constraints.string.PLAYER_KEY_LENGTH+" characters from A to Z"}),game.network.constraints.string.PLAYER_KEY_LENGTH)},sessionKey:function(e,t){return new client.form.Input(e,t,(function(e){if(!game.network.constraints.string.isSessionKey(e))return game.network.constraints.string.SESSION_KEY_LENGTH+" characters from a to z"}),game.network.constraints.string.SESSION_KEY_LENGTH)}},menu:{registration:function(){const e=document.getElementById("registration"),t=client.form.utility.singleOfClass(e,"primary"),n=new client.form.Parent(e,new client.form.Multi([client.form.inputs.playerName(client.form.utility.singleOfTag(e,"div"),t),new client.form.Button(t,(function(){n.validate()&&(n.disable(),client.network.handlers.Registration.handle(client.network.ProcedureSocket.open(),n))})),new client.form.Button(client.form.utility.singleOfClass(e,"secondary"),(function(){client.form.utility.transition(n,client.form.menu.login())}))]));return n},login:function(){const e=document.getElementById("login"),t=client.form.utility.singleOfClass(e,"primary"),n=client.form.inputs.playerKey(client.form.utility.singleOfTag(e,"div"),t);n.restore(client.network.handlers.Login.LOCAL_STORAGE_KEY);const i=new client.form.Parent(e,new client.form.Multi([n,new client.form.Button(t,(function(){i.validate()&&(i.disable(),client.network.handlers.Login.handle(client.network.ProcedureSocket.open(),i))})),new client.form.Button(client.form.utility.singleOfClass(e,"secondary"),(function(){client.form.utility.transition(i,client.form.menu.registration())}))]));return i},loginIfExists:function(){var e=client.form.menu.login();return 0==e.form.forms[0].get().length&&(e.unregister(),e=client.form.menu.registration()),e},lobby:function(e){var t;const n=document.getElementById("lobby"),i=client.form.utility.singleOfClass(document.getElementById("lobby-name"),"value"),r=client.form.utility.singleOfClass(document.getElementById("lobby-key"),"value"),o=client.form.utility.singleOfClass(document.getElementById("lobby-id"),"value"),a=document.getElementById("lobby-toggle-key");function s(){r.innerHTML="&#9679;".repeat(game.network.constraints.string.PLAYER_KEY_LENGTH),a.textContent="Show Key",a.classList.remove("primary"),a.classList.add("secondary"),t=!1}i.textContent=e.player.name,o.textContent=e.player.id,s();const l=new client.form.Parent(n,new client.form.Multi([new client.form.Button(document.getElementById("lobby-change-name"),(function(){client.form.utility.transition(l,client.form.menu.nameChange(e))})),new client.form.Button(a,(function(){t?s():(r.textContent=e.player.key,a.textContent="Hide Key",a.classList.remove("secondary"),a.classList.add("primary"),t=!0)})),new client.form.Button(document.getElementById("lobby-create-session"),(function(){l.disable(),e.handleSessionCreating(l),e.procedureSocket.send(game.network.Procedure.TREE.LOBBY.CREATE.REQUEST.bind())})),new client.form.Button(document.getElementById("lobby-join-session"),(function(){client.form.utility.transition(l,client.form.menu.sessionJoin(e))})),new client.form.Button(document.getElementById("lobby-log-out"),(function(){e.procedureSocket.socket.close(),client.form.utility.transition(l,client.form.menu.login())}))]));return l},nameChange:function(e){const t=document.getElementById("name-change"),n=client.form.utility.singleOfClass(t,"primary"),i=client.form.inputs.playerName(client.form.utility.singleOfTag(t,"div"),n);i.set(e.player.name);const r=new client.form.Parent(t,new client.form.Multi([i,new client.form.Button(n,(function(){r.validate()&&(r.disable(),e.handleNameChanging(r),e.procedureSocket.send(game.network.Procedure.TREE.LOBBY.NAME.CHANGE.REQUEST.bind(i.get())))})),new client.form.Button(client.form.utility.singleOfClass(t,"secondary"),(function(){r.disable(),e.toLobby(r)}))]));return r},sessionJoin:function(e){const t=document.getElementById("session-join"),n=client.form.utility.singleOfClass(t,"primary"),i=client.form.inputs.sessionKey(client.form.utility.singleOfTag(t,"div"),n),r=new client.form.Parent(t,new client.form.Multi([i,new client.form.Button(n,(function(){r.validate()&&(r.disable(),e.handleSessionJoining(r),e.procedureSocket.send(game.network.Procedure.TREE.LOBBY.JOIN.REQUEST.bind(i.get())))})),new client.form.Button(client.form.utility.singleOfClass(t,"secondary"),(function(){r.disable(),e.toLobby(r)}))]));return r},session:function(e){const t=document.getElementById("session"),n=document.getElementById("session-key");client.form.utility.singleOfClass(n,"value").textContent=e.key;const i=new client.form.Parent(t,new client.form.Multi([new client.form.Button(document.getElementById("session-copy"),(function(){navigator.clipboard.writeText(e.key).then((function(){n.classList.remove("off"),n.classList.add("on"),n.focus(),n.classList.add("off"),n.classList.remove("on")}))})),new client.form.Table(client.form.utility.singleOfTag(t,"table")),new client.form.Button(document.getElementById("session-leave"),(function(){i.disable(),e.connection.handleSessionLeaving(i),e.connection.procedureSocket.send(game.network.Procedure.TREE.SESSION.LEAVE.SELF.REQUEST.bind())})),new client.form.Button(document.getElementById("session-start"),(function(){i.disable(),e.connection.procedureSocket.send(game.network.Procedure.TREE.SESSION.START.REQUEST.bind())}))]));return i}},game:{renderers:{empty:function(e){},multi:function(e){return function(t){e.forEach((function(e){e(t)}))}},display:function(e,t,n,i){var r;return function(o){const a=t(o);a!==r&&(a?e.style.setProperty("display","block"):e.style.removeProperty("display"),r=a),(a?n:i)(o)}},textContent:function(e,t){var n;return function(i){const r=t(i).toString();r!==n&&(e.textContent=r,n=r)}}},main:function(e,t,n){const i=document.getElementById("game-exit");return new client.form.Parent(i,new client.form.Button(i,(function(){e.procedureSocket.send(game.network.Procedure.TREE.GAME.LEAVE.SELF.REQUEST.bind(t.nowTicks())),e.handleGameLeaving(),n()})))},transition:function(e){client.form.utility.close(e),client.form.utility.hide(document.getElementById("menu")),document.getElementById("game").style.setProperty("display","block")}},Parent:function(e,t){this.element=e,this.form=t},Multi:function(e){this.forms=e},Input:function(e,t,n,i){this.element=e,this.button=t,this.validator=n,this.maxLength=i,this.validation=client.form.utility.singleOfClass(e,"validation"),this.input=client.form.utility.singleOfTag(e,"input"),this.focusHandler=this.hideValidation.bind(this),this.keyupHandler=this.checkConfirm.bind(this),this.assert(),this.register(),this.set("")},Button:function(e,t){this.element=e,this.handler=t,this.register()},Table:function(e){this.element=e,this.thead=client.form.utility.singleOfTag(e,"thead"),this.tbody=client.form.utility.singleOfTag(e,"tbody")}},webgl:{BasicProgram:function(e){this.gl=e,this.program=client.webgl.loadProgram(e,"basic",client.webgl.BasicProgram.SHADER_DEFS),this.locations=this.buildLocations()},BasicRenderer:function(e,t){this.program=e,this.buffer=e.buildBuffer(t),this.count=t.length},ArrowProgram:function(e){this.gl=e,this.program=client.webgl.loadProgram(e,"arrow",client.webgl.ArrowProgram.SHADER_DEFS),this.locations=this.buildLocations()},ArrowRenderer:function(e,t){this.program=e,this.buffer=e.buildBuffer(t)},ArrowGeometry:function(e,t,n,i){this.matrix=e,this.extents=t,this.color=n,this.alpha=i},ArrowDriver:function(e,t,n){this.fRenderer=e,this.matrix=t,this.length=n},programs:function(e){return{basic:new client.webgl.BasicProgram(e),arrow:new client.webgl.ArrowProgram(e)}},loadShader:function(e,t,n,i){const r=e.createShader(t);if(e.shaderSource(r,Object.keys(i).map((function(e){return["#define",e,i[e]].join(" ")+"\n"})).join("")+document.getElementById(n).textContent),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(r));return r},loadProgram:function(e,t,n){const i=e.createProgram();if(e.attachShader(i,client.webgl.loadShader(e,e.VERTEX_SHADER,t+"-vertex-shader",n)),e.attachShader(i,client.webgl.loadShader(e,e.FRAGMENT_SHADER,t+"-fragment-shader",n)),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(i));return i},interleaveAttribPointer:function(e,t,n,i){const r=i.map((function(e){return e.components})).reduce((function(e,t){return e+t}),0);var o=0;i.forEach((function(i){e.vertexAttribPointer(i.location,i.components,t,i.normalized,r*n,o*n),o+=i.components}))},canvas:function(){return client.form.utility.singleOfTag(document,"canvas")},open:function(){const e=client.webgl.canvas();e.style.setProperty("display","block");const t=e.getContext("webgl",{alpha:!1});return t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t}},State:function(e,t,n,i,r,o,a){this.reference=e,this.playerDriver=t,this.trace=n,this.timeSync=i,this.indexEvent=r,this.timeEvent=o,this.prunerData=a},Controller:function(e,t,n){this.gl=e,this.connection=t,this.state=n,this.resizeHandler=this.handleResize.bind(this),this.lockChangeHandler=this.handleLockChange.bind(this),this.mouseMoveHandler=this.handleMouseMove.bind(this),this.wheelHandler=this.handleWheel.bind(this),this.lockedClickHandler=this.handleLockedClick.bind(this),this.lockedMouseDownHandler=this.handleLockedMouseDown.bind(this),this.lockedMouseUpHandler=this.handleLockedMouseUp.bind(this),this.unlockedClickHandler=this.handleUnlockedClick.bind(this),this.register()},Camera:function(e,t,n,i,r){this.position=e,this.pan=t,this.tilt=n,this.zoom=i,this.ratio=r},load:function(){client.form.menu.loginIfExists().show()}};if(client.network.handlers.lobby.Main.prototype.handleSocketClose=function(){},client.network.handlers.lobby.NameChanging.prototype.handle_LOBBY_NAME_CHANGE_RESPONSE=function(){this.connection.player.name=this.form.form.forms[0].get(),this.connection.handleLobby(),this.connection.toLobby(this.form)},client.network.handlers.lobby.NameChanging.prototype.handleSocketClose=function(){},client.network.handlers.lobby.SessionCreating.prototype.handle_LOBBY_CREATE_RESPONSE=function(e){new client.network.Session(this.connection,e).toSession(this.form,[])},client.network.handlers.lobby.SessionCreating.prototype.handleSocketClose=function(){},client.network.handlers.lobby.SessionJoining.prototype.handle_LOBBY_JOIN_RESPONSE_CONFIRM_SESSION=function(e){this.session.toSession(this.form,e.map(game.network.Player.fromData))},client.network.handlers.lobby.SessionJoining.prototype.handle_LOBBY_JOIN_RESPONSE_CONFIRM_GAME=function(e,t,n,i,r,o,a){client.form.game.transition(this.form),new client.network.Launcher(this.session,this.reference,n,i,r,o,a.map(client.State.playerDriverFromData)).launch(t,e).insertEnterAction(t,this.session.connection.player)},client.network.handlers.lobby.SessionJoining.prototype.handle_LOBBY_JOIN_RESPONSE_UNKNOWN=function(){this.form.enable(),this.form.form.forms[0].showValidation("No session exists with this key"),this.connection.handleLobby()},client.network.handlers.lobby.SessionJoining.prototype.handleSocketClose=function(){},client.network.handlers.session.Main.prototype.handle_SESSION_ENTER=function(e,t){this.member.add(new game.network.Player(e,null,t)),this.update()},client.network.handlers.session.Main.prototype.handle_SESSION_LEAVE_OTHER=function(e){this.member.remove(e),this.update()},client.network.handlers.session.Main.prototype.handle_SESSION_START_RESPONSE=function(){this.member.session.connection.procedureSocket.send(game.network.Procedure.TREE.GAME.START.REQUEST.bind()),this.member.handleStarting(0,client.form.game.transition.bind(null,this.form))},client.network.handlers.session.Main.prototype.handleSocketClose=function(){},client.network.handlers.session.Main.prototype.update=function(){this.form.form.forms[1].update(this.member.players().sort(game.network.Player.COMPARATOR).map((function(e,t){return[t+1,e.name,e.id]})))},client.network.handlers.session.Leaving.prototype.handle_SESSION_ENTER=function(e,t){},client.network.handlers.session.Leaving.prototype.handle_SESSION_LEAVE_SELF_RESPONSE=function(){this.connection.handleLobby(),this.connection.toLobby(this.form)},client.network.handlers.session.Leaving.prototype.handle_SESSION_LEAVE_OTHER=function(e){},client.network.handlers.session.Leaving.prototype.handle_SESSION_START_RESPONSE=function(){},client.network.handlers.session.Leaving.prototype.handleSocketClose=function(){},client.network.handlers.game.Starting.prototype.handle_GAME_ENTER=function(e,t){this.launcher.queueEnterAction(e,game.network.Player.fromData(t))},client.network.handlers.game.Starting.prototype.handle_GAME_LEAVE_OTHER=function(e,t){this.launcher.queueLeaveAction(e,t)},client.network.handlers.game.Starting.prototype.handle_GAME_FRAME=function(e,t,n,i,r){this.launcher.queueFrameAction(e,t,n,i,r)},client.network.handlers.game.Starting.prototype.handle_GAME_HIT=function(e,t,n,i){this.launcher.queueHitAction(e,t,n,i)},client.network.handlers.game.Starting.prototype.handle_GAME_START_RESPONSE=function(e){this.callable(),this.launcher.launch(e,this.course)},client.network.handlers.game.Starting.prototype.handleSocketClose=function(){},client.network.handlers.game.Main.prototype.handle_GAME_ENTER=function(e,t){this.state.insertEnterAction(e,game.network.Player.fromData(t))},client.network.handlers.game.Main.prototype.handle_GAME_LEAVE_OTHER=function(e,t){this.state.insertLeaveAction(e,t)},client.network.handlers.game.Main.prototype.handle_GAME_FRAME=function(e,t,n,i,r){this.state.insertFrameAction(e,t,n,i,r)},client.network.handlers.game.Main.prototype.handle_GAME_HIT_OTHER=function(e,t,n,i){this.state.insertHitAction(e,t,n,i)},client.network.handlers.game.Main.prototype.handle_GAME_END=function(e){if(this.cancel(),this.course+1<game.network.COURSES().length)this.session.connection.procedureSocket.send(game.network.Procedure.TREE.GAME.START.REQUEST.bind()),this.session.handleStartingTransition(this.course+1,e.map(client.State.playerDriverFromDataGlobal)),client.form.utility.show(document.getElementById("menu"),this.session.connection.procedureSocket.handler.callable);else{const t=client.form.menu.session(this.session);this.session.handleSession(this.session.connection.tableOthers(e),t),client.form.utility.open(t),client.form.utility.show(document.getElementById("menu"),(function(){document.getElementById("game").style.removeProperty("display")})),document.exitPointerLock()}},client.network.handlers.game.Main.prototype.handleSocketClose=function(){},client.network.handlers.game.Leaving.prototype.handle_GAME_LEAVE_SELF_RESPONSE=function(){this.connection.handleLobby(),this.transition()},client.network.handlers.game.Leaving.prototype.handle_GAME_FRAME=function(e,t,n){},client.network.handlers.game.Leaving.prototype.handle_GAME_HIT_OTHER=function(e,t,n,i){},client.network.handlers.game.Leaving.prototype.handleSocketClose=function(){},client.network.handlers.game.Leaving.prototype.transition=function(){client.form.utility.open(client.form.menu.lobby(this.connection)),client.form.utility.show(document.getElementById("menu"),(function(){document.getElementById("game").style.removeProperty("display")}))},client.network.handlers.Registration.handle=function(e,t){e.handler=new client.network.handlers.Registration(e,t)},client.network.handlers.Registration.prototype.name=function(){return this.form.form.forms[0].get()},client.network.handlers.Registration.prototype.handleSocketOpen=function(){this.procedureSocket.send(game.network.Procedure.TREE.REGISTRATION.REQUEST.bind(this.name()))},client.network.handlers.Registration.prototype.handle_REGISTRATION_RESPONSE=function(e,t){window.localStorage.setItem(client.network.handlers.Login.LOCAL_STORAGE_KEY,t);const n=new client.network.Connection(this.procedureSocket,new game.network.Player(e,t,this.name()));n.handleLobby(),n.toLobby(this.form)},client.network.handlers.Registration.prototype.handleSocketClose=function(){},client.network.handlers.Login.LOCAL_STORAGE_KEY="multi-golf-player-key",client.network.handlers.Login.handle=function(e,t){e.handler=new client.network.handlers.Login(e,t)},client.network.handlers.Login.prototype.key=function(){return this.form.form.forms[0].get()},client.network.handlers.Login.prototype.handleSocketOpen=function(){this.procedureSocket.send(game.network.Procedure.TREE.LOGIN.REQUEST.bind(this.key()))},client.network.handlers.Login.prototype.handle_LOGIN_RESPONSE_CONFIRM=function(e,t){const n=new client.network.Connection(this.procedureSocket,new game.network.Player(e,this.key(),t));n.handleLobby(),n.toLobby(this.form)},client.network.handlers.Login.prototype.handle_LOGIN_RESPONSE_MULTIPLE=function(){this.form.enable(),this.form.form.forms[0].showValidation("Already logged in from another client")},client.network.handlers.Login.prototype.handle_LOGIN_RESPONSE_UNKNOWN=function(){this.form.enable(),this.form.form.forms[0].showValidation("No player exists with this key")},client.network.handlers.Login.prototype.handleSocketClose=function(){},client.network.queues.Instant.prototype.push=function(e,t){t()},client.network.queues.Delayed.MIN_DELAY=client.params.matchInteger("minDelay"),client.network.queues.Delayed.MAX_DELAY=client.params.matchInteger("maxDelay"),client.network.queues.Delayed.DELAY_ENABLED=null!=client.network.queues.Delayed.MIN_DELAY&&null!=client.network.queues.Delayed.MAX_DELAY&&client.network.queues.Delayed.MIN_DELAY<=client.network.queues.Delayed.MAX_DELAY,client.network.queues.Delayed.DELAY_ENABLED,client.network.queues.Delayed.prototype.randomDelay=function(){return game.utility.random.range(this.minDelay,this.maxDelay)},client.network.queues.Delayed.prototype.push=function(e,t){const n=this.randomDelay(),i={name:e,callable:t,expired:!1};this.data.push(i),setTimeout(function(){i.expired=!0,this.process()}.bind(this),n)},client.network.queues.Delayed.prototype.process=function(){for(;this.data.length>0&&this.data[0].expired;){this.data.splice(0,1)[0].callable()}},client.network.queues.build=client.network.queues.Delayed.DELAY_ENABLED?function(){return new client.network.queues.Delayed(client.network.queues.Delayed.MIN_DELAY,client.network.queues.Delayed.MAX_DELAY)}:function(){return new client.network.queues.Instant},client.network.ProcedureSocket.DOMAIN=client.params.matchString("domain"),client.network.ProcedureSocket.DOMAIN,client.network.ProcedureSocket.INSECURE=client.params.matchBoolean("insecure"),client.network.ProcedureSocket.INSECURE,client.network.ProcedureSocket.SERVER_URL=(client.network.ProcedureSocket.INSECURE?"ws":"wss")+"://"+(client.network.ProcedureSocket.DOMAIN||game.network.DOMAIN)+":"+game.network.PORT,client.network.ProcedureSocket.FLOAT_ERROR=client.params.matchFloat("floatError"),null!=client.network.ProcedureSocket.FLOAT_ERROR&&(client.network.ProcedureSocket.MAPPER=function(e,t){return Number.isFinite(t)&&!Number.isInteger(t)?Math.pow(client.network.ProcedureSocket.FLOAT_ERROR,2*Math.random()-1)*t:t}),client.network.ProcedureSocket.open=function(){return new client.network.ProcedureSocket(new WebSocket(client.network.ProcedureSocket.SERVER_URL),client.network.ProcedureSocket.MAPPER)},client.network.ProcedureSocket.prototype.register=function(){this.socket.addEventListener("open",this.handleOpen.bind(this)),this.socket.addEventListener("message",this.handleMessage.bind(this)),this.socket.addEventListener("close",this.handleClose.bind(this)),this.socket.addEventListener("error",this.handleError.bind(this))},client.network.ProcedureSocket.prototype.handleOpen=function(e){this.inQueue.push("open",function(){this.handler.handleSocketOpen()}.bind(this))},client.network.ProcedureSocket.prototype.handleMessage=function(e){this.inQueue.push("message",function(){try{game.network.Parser.INSTANCE.parse(e.data,this.mapper).handle(this.handler)}catch(e){this.socket.close(),alert("Unexpected network message received")}}.bind(this))},client.network.ProcedureSocket.prototype.handleClose=function(e){this.inQueue.push("close",function(){this.handler.handleSocketClose()}.bind(this))},client.network.ProcedureSocket.prototype.handleError=function(e){this.inQueue.push("error",(function(){alert("Unexpected network error occurred")}))},client.network.ProcedureSocket.prototype.send=function(e){this.outQueue.push("send",function(){this.socket.send(game.network.Parser.INSTANCE.unparse(e,this.mapper))}.bind(this))},client.network.Connection.prototype.handleLobby=function(){this.procedureSocket.handler=new client.network.handlers.lobby.Main(this)},client.network.Connection.prototype.handleNameChanging=function(e){this.procedureSocket.handler=new client.network.handlers.lobby.NameChanging(this,e)},client.network.Connection.prototype.handleSessionCreating=function(e){this.procedureSocket.handler=new client.network.handlers.lobby.SessionCreating(this,e)},client.network.Connection.prototype.handleSessionJoining=function(e){this.procedureSocket.handler=new client.network.handlers.lobby.SessionJoining(new client.network.Session(this,e.form.forms[0].get()),e,performance.now())},client.network.Connection.prototype.handleSessionLeaving=function(e){this.procedureSocket.handler=new client.network.handlers.session.Leaving(this,e)},client.network.Connection.prototype.handleGameLeaving=function(){this.procedureSocket.handler=new client.network.handlers.game.Leaving(this)},client.network.Connection.prototype.toLobby=function(e){client.form.utility.transition(e,client.form.menu.lobby(this))},client.network.Connection.prototype.tableOthers=function(e){return e.map(game.network.PlayerState.fromDataGlobal).map((function(e){return e.player})).filter(function(e){return e.id!=this.player.id}.bind(this))},client.network.Session.prototype.handleSession=function(e,t){this.connection.procedureSocket.handler=new client.network.handlers.session.Main(new client.network.Member(this,e),t)},client.network.Session.prototype.handleStarting=function(e,t,n){this.connection.procedureSocket.handler=new client.network.handlers.game.Starting(new client.network.Launcher(this,performance.now(),0,0,0,0,t),e,n)},client.network.Session.prototype.handleStartingTransition=function(e,t){var n=!1;this.handleStarting(e,t,(function(){n&&client.form.utility.hide(document.getElementById("menu")),n=!0}))},client.network.Session.prototype.handleGame=function(e,t,n){this.connection.procedureSocket.handler=new client.network.handlers.game.Main(this,e,t,n)},client.network.Session.prototype.toSession=function(e,t){const n=client.form.menu.session(this);this.handleSession(t,n),client.form.utility.transition(e,n)},client.network.Member.prototype.handleStarting=function(e,t){this.session.handleStarting(e,this.playerActions(),t)},client.network.Member.prototype.add=function(e){game.utility.assert(e.id!=this.session.connection.player.id,"Cannot add player with self ID"),game.utility.collection.map.setNew(this.idToPlayer,e.id,e)},client.network.Member.prototype.remove=function(e){game.utility.assert(e!=this.session.connection.player.id,"Cannot remove player with self ID"),game.utility.collection.map.deleteExisting(this.idToPlayer,e)},client.network.Member.prototype.players=function(){return game.utility.collection.values(this.idToPlayer)},client.network.Member.prototype.playerActions=function(){return this.players().map((function(e){return client.State.playerDriverWithPlayer(e)}))},client.network.Launcher.tableRenderer=function(){return new client.form.Table(client.form.utility.singleOfTag(document.getElementById("game"),"table")).renderer(client.network.Launcher.extractRanking)},client.network.Launcher.gameStartRenderer=function(){const e=document.getElementById("game-start");return client.form.game.renderers.display(e,(function(e){return e.unconditionalDriver.unconditionalDriver.time<game.timing.GAME_START_DURATION}),client.form.game.renderers.textContent(e.getElementsByTagName("div")[1],(function(e){return Math.ceil(game.timing.GAME_START_DURATION-e.unconditionalDriver.unconditionalDriver.time)})),client.form.game.renderers.empty)},client.network.Launcher.gameEndRenderer=function(){const e=document.getElementById("game-end");return client.form.game.renderers.display(e,(function(e){return e.satisfied}),client.form.game.renderers.textContent(e.getElementsByTagName("div")[1],(function(e){return Math.ceil(Math.max(game.timing.GAME_END_DURATION-e.conditionalDriver.time,0))})),client.form.game.renderers.empty)},client.network.Launcher.timerRenderer=function(){return client.form.game.renderers.textContent(document.getElementById("timer"),(function(e){const t=Math.ceil(game.utility.clamp(game.timing.PLAYABLE_END-(e.unconditionalDriver.unconditionalDriver.time*game.network.constraints.number.FLOAT_TOLERANCE-e.conditionalDriver.time/game.network.constraints.number.FLOAT_TOLERANCE),0,game.timing.PLAYABLE_DURATION)),n=t%60;return Math.floor(t/60)+":"+(n<10?"0":"")+n}))},client.network.Launcher.extractRanking=function(e){var t,n,i=game.utility.collection.values(e.unconditionalDriver.conditionalDriver.drivers).map((function(e){return e.driver.current}));return e.satisfied&&(i=i.map((function(e){return e.maxStrokes()}))),i.sort(game.network.PlayerState.COMPARATOR).map((function(e,i){return i>0&&n==e.strokes.total?t++:(t=0,n=e.strokes.total),[i-t+1,e.player.name+" <span>("+e.player.id+")</span>",e.strokes.current+" ("+e.strokes.total+")",e.ball.isCompleted()?"&check;":e.hasMaxStrokes()&&e.ball.isResting()?"&cross;":"<span>&check;</span>"]}))},client.network.Launcher.playerDriver=function(e,t){return new game.state.drivers.RendererWrapper(game.state.drivers.Player.from(e),game.physics.Ball.SPHERE.renderer(t.basic,Math.PI/12,new game.model.Color(1,1,1),new game.model.Color(1,0,0)))},client.network.Launcher.backgroundDriver=function(e){return new game.state.drivers.RendererOverride(game.state.drivers.idle,game.utility.constant(new game.state.renderers.Wrapper(game.geometry.void,(function(){new game.model.Color(.2,.2,.2).glClear(e),e.clear(e.COLOR_BUFFER_BIT)}))))},client.network.Launcher.courseDriver=function(e,t){return new game.state.drivers.RendererOverride(game.state.drivers.idle,game.utility.constant(new game.state.renderers.Wrapper(game.geometry.Matrix.IDENTITY,e.renderer(t.basic))))},client.network.Launcher.arrowAction=function(e){return game.state.drivers.Camera.map(game.state.drivers.Multi.map(new Map([["arrow",e],["players",game.utility.identity]]),game.state.drivers.Multi.OTHERS.KEEP,game.state.drivers.Multi.ORDERED.OTHERS_FIRST),game.utility.identity)},client.network.Launcher.prototype.now=function(){return(this.reference+performance.now())/2},client.network.Launcher.prototype.applyQueue=function(e){this.queue.forEach((function(t){t(e)}))},client.network.Launcher.prototype.queueEnterAction=function(e,t){this.queue.push((function(n){n.insertEnterAction(e,t)}))},client.network.Launcher.prototype.queueLeaveAction=function(e,t){this.queue.push((function(n){n.insertLeaveAction(e,t)}))},client.network.Launcher.prototype.queueFrameAction=function(e,t,n,i,r){this.queue.push((function(o){o.insertFrameAction(e,t,n,i,r)}))},client.network.Launcher.prototype.queueHitAction=function(e,t,n,i){this.queue.push((function(r){r.insertHitAction(e,t,n,i)}))},client.network.Launcher.prototype.playerEndRenderer=function(){const e=this,t=document.getElementById("player-end"),n=t.querySelectorAll("#player-end > div"),i=n[0].getElementsByTagName("div");function r(t,n){const i=e.selfPlayerState(t.unconditionalDriver.conditionalDriver);return i&&n(i)}function o(e,t){return client.form.game.renderers.display(i[e],(function(e){return t}),client.form.game.renderers.empty,client.form.game.renderers.empty)}return client.form.game.renderers.display(t,(function(e){return e.unconditionalDriver.unconditionalDriver.time>game.timing.PLAYABLE_END||r(e,(function(e){return e.ended()}))}),client.form.game.renderers.multi([client.form.game.renderers.display(i[0],(function(e){return r(e,(function(e){return e.ball.isCompleted()}))}),client.form.game.renderers.multi([o(1,!1),o(2,!1)]),client.form.game.renderers.display(i[1],(function(e){return r(e,(function(e){return e.endedMaxStrokes()}))}),o(2,!1),o(2,!0))),client.form.game.renderers.display(n[1],(function(e){return!e.satisfied}),client.form.game.renderers.empty,client.form.game.renderers.empty)]),client.form.game.renderers.empty)},client.network.Launcher.prototype.playersDriver=function(e){return game.state.drivers.RendererOverride.discrete(game.timing.driver(new game.state.drivers.Multi(new Map(this.playerActions.map((function(t){const n=t(e);return[n.driver.current.player.id,n]})).sort(game.utility.collection.map.KEY_COMPARATOR))),this.totalTime,this.endTime,(function(e){return game.utility.collection.values(e.drivers).every((function(e){return e.driver.current.ended()}))})),client.form.game.renderers.multi([client.network.Launcher.tableRenderer(),client.network.Launcher.gameStartRenderer(),client.network.Launcher.gameEndRenderer(),this.playerEndRenderer(),client.network.Launcher.timerRenderer()]))},client.network.Launcher.prototype.selfPlayerState=function(e){const t=this.session.connection.player.id;if(e.drivers.has(t))return e.drivers.get(t).driver.current},client.network.Launcher.prototype.alignArrow=function(e,t){const n=t.driver.drivers.get("players").driver.unconditionalDriver;if(n.satisfied){const i=this.selfPlayerState(n.conditionalDriver);if(i&&i.ball.isHittable())return function(t,n){return n||(n=e),n.replace({matrix:t})}.bind(null,game.geometry.Matrix.rotationZ(t.camera.pan).dot(i.ball.floorMatrix()))}return function(e){}},client.network.Launcher.prototype.cameraPosition=function(e){const t=this.selfPlayerState(e.drivers.get("players").driver.unconditionalDriver.conditionalDriver);return t?t.ball.motion.position:new game.geometry.Vector(0,0,0)},client.network.Launcher.prototype.driver=function(e,t,n,i,r){return new game.state.drivers.Actioning(new game.state.drivers.Camera(new game.state.drivers.Multi(new Map([["background",e],["course",t],["players",i]])),r,this.cameraPosition.bind(this)),game.state.actions.dynamic(function(e){return client.network.Launcher.arrowAction(this.alignArrow(n,e))}.bind(this)))},client.network.Launcher.prototype.buildState=function(e,t,n){const i=client.webgl.programs(e),r=n(),o=new game.collision.Index(game.physics.Ball.SPHERE.size());o.addTriangles(r.body.collision);const a=game.physics.Ball.from(r.origin,game.physics.Ball.SPHERE.radius,o,!1),s=game.network.PlayerState.initial(this.session.connection.player,a),l=client.network.Launcher.playerDriver(s,i),c=new client.webgl.ArrowDriver(client.webgl.ArrowGeometry.renderer(i.arrow),game.geometry.Matrix.IDENTITY,null),u=new client.Camera(a.motion.position,0,Math.PI/6,1,1),m=client.State.build(t,l,new game.state.Frame(this.index,this.timestamp,this.driver(client.network.Launcher.backgroundDriver(e),client.network.Launcher.courseDriver(r,i),c,this.playersDriver(l),u)));return this.applyQueue(m),m},client.network.Launcher.prototype.launch=function(e,t){const n=client.webgl.open(),i=this.buildState(n,this.now()-game.timing.ticksToMs(e),game.network.COURSES()[t]),r=new client.Controller(n,this.session.connection,i),o=function(){this(),r.unregister(),a.unregister(),a.disable()}.bind(i.run()),a=client.form.game.main(this.session.connection,i,o);return a.enable(),this.session.handleGame(t,i,o),i},client.form.Parent.prototype.unregister=function(){this.form.unregister()},client.form.Parent.prototype.disable=function(){this.form.disable()},client.form.Parent.prototype.enable=function(){this.form.enable()},client.form.Parent.prototype.hide=function(e){client.form.utility.hide(this.element,e)},client.form.Parent.prototype.show=function(){client.form.utility.show(this.element)},client.form.Parent.prototype.validate=function(){return this.form.validate()},client.form.Multi.prototype.unregister=function(){this.forms.forEach((function(e){e.unregister()}))},client.form.Multi.prototype.disable=function(){this.forms.forEach((function(e){e.disable()}))},client.form.Multi.prototype.enable=function(){this.forms.forEach((function(e){e.enable()}))},client.form.Multi.prototype.validate=function(){return this.forms.map((function(e){return e.validate()})).every(game.utility.identity)},client.form.Input.prototype.assert=function(){game.utility.assert(3==this.element.children.length,"Three children expected");const e=this.element.children[0],t=this.element.children[1],n=this.element.children[2],i=n.getAttribute("id");game.utility.assert(null!=i,"Input expected to have ID"),game.utility.assert("LABEL"==e.tagName,"Label expected"),game.utility.assert(e.getAttribute("for")==i,"Header label should refer input"),game.utility.assert(e.classList.contains("header"),"Header class expected"),game.utility.assert("LABEL"==t.tagName,"Label expected"),game.utility.assert(t.getAttribute("for")==i,"Validation label should refer input"),game.utility.assert(t.classList.contains("validation"),"Validation class expected"),game.utility.assert("INPUT"==n.tagName,"Input expected"),game.utility.assert("text"==n.getAttribute("type"),"Unexpected input type"),game.utility.assert(n.getAttribute("maxlength")==this.maxLength.toString(),"Wrong maxlength")},client.form.Input.prototype.register=function(){this.input.addEventListener("focus",this.focusHandler),this.input.addEventListener("keyup",this.keyupHandler)},client.form.Input.prototype.unregister=function(){this.input.removeEventListener("focus",this.focusHandler),this.input.removeEventListener("keyup",this.keyupHandler)},client.form.Input.prototype.disable=function(){this.hideValidation(),this.input.disabled=!0},client.form.Input.prototype.enable=function(){this.input.disabled=!1},client.form.Input.prototype.validate=function(){const e=this.get(),t=this.validator(e);return null==t||(this.showValidation(t),!1)},client.form.Input.prototype.get=function(){return this.input.value},client.form.Input.prototype.set=function(e){this.input.value=e},client.form.Input.prototype.restore=function(e){const t=window.localStorage.getItem(e);null!=t&&(null==this.validator(t)?this.set(t):window.localStorage.removeItem(e))},client.form.Input.prototype.showValidation=function(e){this.validation.textContent=e,this.validation.style.setProperty("display","block"),this.input.classList.add("invalid")},client.form.Input.prototype.hideValidation=function(){this.validation.textContent="",this.validation.style.removeProperty("display"),this.input.classList.remove("invalid")},client.form.Input.prototype.checkConfirm=function(e){"Enter"==e.key&&(this.input.blur(),this.button.click())},client.form.Button.prototype.register=function(){this.element.addEventListener("click",this.handler)},client.form.Button.prototype.unregister=function(){this.element.removeEventListener("click",this.handler)},client.form.Button.prototype.disable=function(){this.element.disabled=!0},client.form.Button.prototype.enable=function(){this.element.disabled=!1},client.form.Button.prototype.validate=function(){return!0},client.form.Table.prototype.unregister=function(){},client.form.Table.prototype.disable=function(){},client.form.Table.prototype.enable=function(){},client.form.Table.prototype.validate=function(){return!0},client.form.Table.prototype.update=function(e){const t=this.thead.getElementsByTagName("th").length;this.tbody.textContent="",e.forEach(function(e){game.utility.assert(e.length==t,"Wrong number of columns");const n=document.createElement("tr");e.forEach((function(e){const t=document.createElement("td");t.innerHTML=e,n.appendChild(t)})),this.tbody.appendChild(n)}.bind(this))},client.form.Table.prototype.renderer=function(e){var t=[];return function(n){const i=e(n);game.utility.arraysEqual(i,t,2)||(this.update(i),t=i)}.bind(this)},client.webgl.BasicProgram.SHADER_DEFS={LIGHT_VECTOR:new game.geometry.Vector(.5,1,1.5).normalize().toShader(),LIGHT_CENTER:"0.6",LIGHT_SCALE:"0.25",CHECKER_SIZE:"2.0",CHECKER_MULTIPLIER:"0.9",CHECKER_SLOPE_MIN:"0.5",CHECKER_SLOPE_MAX:"1.0"},client.webgl.BasicProgram.prototype.buildLocations=function(){return{position:this.gl.getAttribLocation(this.program,"aPosition"),normal:this.gl.getAttribLocation(this.program,"aNormal"),color:this.gl.getAttribLocation(this.program,"aColor"),checker:this.gl.getAttribLocation(this.program,"aChecker"),matrix:this.gl.getUniformLocation(this.program,"uMatrix")}},client.webgl.BasicProgram.prototype.buildBuffer=function(e){const t=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(game.utility.flatten(e.map((function(e){return e.data()})))),this.gl.STATIC_DRAW),t},client.webgl.BasicProgram.prototype.render=function(e,t,n){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),client.webgl.interleaveAttribPointer(this.gl,this.gl.FLOAT,Float32Array.BYTES_PER_ELEMENT,[{location:this.locations.position,components:3,normalized:!1},{location:this.locations.normal,components:3,normalized:!1},{location:this.locations.color,components:3,normalized:!1},{location:this.locations.checker,components:1,normalized:!1}]),this.gl.enableVertexAttribArray(this.locations.position),this.gl.enableVertexAttribArray(this.locations.normal),this.gl.enableVertexAttribArray(this.locations.color),this.gl.enableVertexAttribArray(this.locations.checker),this.gl.useProgram(this.program),this.gl.uniformMatrix4fv(this.locations.matrix,!1,n.data),this.gl.drawArrays(this.gl.TRIANGLES,0,t)},client.webgl.BasicProgram.prototype.renderer=function(e){return new client.webgl.BasicRenderer(this,game.model.Triangle.vertices(e))},client.webgl.BasicRenderer.prototype.render=function(e){this.program.render(this.buffer,this.count,e)},client.webgl.ArrowProgram.SHADER_DEFS={INNER_RADIUS:"0.6",HALF_WIDTH:"0.2",TIP_RATIO:"1.75",SECTION_LENGTH:"2.0",SECTION_GAP:"0.075"},client.webgl.ArrowProgram.prototype.buildLocations=function(){return{position:this.gl.getAttribLocation(this.program,"aPosition"),mapping:this.gl.getAttribLocation(this.program,"aMapping"),matrix:this.gl.getUniformLocation(this.program,"uMatrix"),extents:this.gl.getUniformLocation(this.program,"uExtents"),color:this.gl.getUniformLocation(this.program,"uColor")}},client.webgl.ArrowProgram.prototype.buildBuffer=function(e){const t=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(game.utility.flatten([new game.geometry.Vector(-e.v,e.v,0),new game.geometry.Vector(e.v,e.v,0),new game.geometry.Vector(e.v,-Math.max(e.v,e.u),0),new game.geometry.Vector(-e.v,-Math.max(e.v,e.u),0)].map((function(e){return e.data().concat(e.xyMapping().rotate90().data())})))),this.gl.STATIC_DRAW),t},client.webgl.ArrowProgram.prototype.render=function(e,t){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),client.webgl.interleaveAttribPointer(this.gl,this.gl.FLOAT,Float32Array.BYTES_PER_ELEMENT,[{location:this.locations.position,components:3,normalized:!1},{location:this.locations.mapping,components:2,normalized:!1}]),this.gl.enableVertexAttribArray(this.locations.position),this.gl.enableVertexAttribArray(this.locations.mapping),this.gl.useProgram(this.program),this.gl.uniformMatrix4fv(this.locations.matrix,!1,t.matrix.data),this.gl.uniform2fv(this.locations.extents,t.extents.data()),this.gl.uniform4fv(this.locations.color,t.alphaColor()),this.gl.drawArrays(this.gl.TRIANGLE_FAN,0,4)},client.webgl.ArrowProgram.prototype.renderer=function(e){return new client.webgl.ArrowRenderer(this,e)},client.webgl.ArrowRenderer.prototype.render=function(e){this.program.render(this.buffer,e)},client.webgl.ArrowGeometry.ARROW_RADIUS=1,client.webgl.ArrowGeometry.ARROW_LENGTH_MIN=client.webgl.ArrowGeometry.ARROW_RADIUS*(1+parseFloat(client.webgl.ArrowProgram.SHADER_DEFS.TIP_RATIO)*parseFloat(client.webgl.ArrowProgram.SHADER_DEFS.HALF_WIDTH)),client.webgl.ArrowGeometry.ARROW_SECTION_COUNT=4,client.webgl.ArrowGeometry.ARROW_LENGTH_MAX=client.webgl.ArrowGeometry.ARROW_RADIUS*(parseFloat(client.webgl.ArrowProgram.SHADER_DEFS.INNER_RADIUS)+client.webgl.ArrowGeometry.ARROW_SECTION_COUNT*parseFloat(client.webgl.ArrowProgram.SHADER_DEFS.SECTION_LENGTH)),client.webgl.ArrowGeometry.ARROW_EXTENTS=new game.geometry.Mapping(client.webgl.ArrowGeometry.ARROW_LENGTH_MAX,client.webgl.ArrowGeometry.ARROW_RADIUS),client.webgl.ArrowGeometry.ARROW_ALPHA_IDLE=.5,client.webgl.ArrowGeometry.ARROW_COLOR_MIN=new game.model.Color(1,1,0),client.webgl.ArrowGeometry.ARROW_COLOR_MAX=new game.model.Color(1,0,0),client.webgl.ArrowGeometry.renderer=function(e){const t=e.gl,n=e.renderer(client.webgl.ArrowGeometry.ARROW_EXTENTS);return function(e){t.disable(t.DEPTH_TEST),n.render(e),t.enable(t.DEPTH_TEST)}},client.webgl.ArrowGeometry.prototype.alphaColor=function(){return this.color.data().concat(this.alpha)},client.webgl.ArrowGeometry.prototype.dot=function(e){return new client.webgl.ArrowGeometry(this.matrix.dot(e),this.extents,this.color,this.alpha)},client.webgl.ArrowGeometry.prototype.interpolate=function(e,t){return new client.webgl.ArrowGeometry(this.matrix.interpolate(e.matrix,t),this.extents.interpolate(e.extents,t),this.color.interpolate(e.color,t),game.utility.interpolate(this.alpha,e.alpha,t))},client.webgl.ArrowDriver.prototype.delta=function(){return game.timing.NORMAL_DELTA},client.webgl.ArrowDriver.prototype.drive=function(e){return this},client.webgl.ArrowDriver.prototype.renderer=function(){return new game.state.renderers.Wrapper(new client.webgl.ArrowGeometry(this.matrix,new game.geometry.Mapping(game.utility.interpolate(client.webgl.ArrowGeometry.ARROW_LENGTH_MIN,client.webgl.ArrowGeometry.ARROW_LENGTH_MAX,this.length),client.webgl.ArrowGeometry.ARROW_RADIUS),client.webgl.ArrowGeometry.ARROW_COLOR_MIN.interpolate(client.webgl.ArrowGeometry.ARROW_COLOR_MAX,null!=this.length?this.length:0),null==this.length?client.webgl.ArrowGeometry.ARROW_ALPHA_IDLE:1),this.fRenderer)},client.webgl.ArrowDriver.prototype.replace=function(e){const t=game.utility.mergeObjects([this,e]);return new client.webgl.ArrowDriver(t.fRenderer,t.matrix,t.length)},client.State.build=function(e,t,n){const i=new game.state.updaters.TimeEvent,r=new game.state.updaters.IndexEvent,o=new game.state.updaters.TimeSync,a={index:0};return new client.State(e,t,new game.state.Trace(n,game.state.updaters.smoother(game.state.updaters.multi([i.pruner(),r.pruner(),o.pruner()]),game.state.updaters.multi([game.state.updaters.driver,i.applier(),game.state.updaters.ifLastChanged(r.applier(),game.state.updaters.extrapolate),o.applier()]),game.state.updaters.indexPruner(game.state.updaters.indexPruner.reference(a),1,2),5e-4)),o,r,i,a)},client.State.tableMultiAction=function(e){return game.state.drivers.Multi.map(e,game.state.drivers.Multi.OTHERS.KEEP,game.state.drivers.Multi.ORDERED.ASCENDING)},client.State.tableMapAction=function(e){return game.state.drivers.RendererOverride.map(game.state.drivers.Conditional.mapUnconditional(game.state.drivers.Conditional.mapConditional(client.State.tableMultiAction(e))))},client.State.tableTimestampsAction=function(e,t,n){return game.state.drivers.RendererOverride.map(game.state.drivers.Conditional.mapBoth(game.state.drivers.Conditional.mapBoth(game.state.drivers.Timer.action(e),client.State.tableMultiAction(n)),game.state.drivers.Timer.action(t)))},client.State.tableRemoveAction=function(e){return client.State.tableMapAction(new Map([[e,game.state.actions.existing(game.state.actions.constant())]]))},client.State.tableHitAction=function(e,t,n){return client.State.tableMapAction(new Map([[e,client.State.playerDriverHitAction(t,n)]]))},client.State.playerDriverWithPlayer=function(e){return game.state.drivers.RendererWrapper.map(game.state.drivers.Player.mapSame((function(t){return t.withPlayer(e)})))},client.State.playerDriverFromData=function(e){return game.state.drivers.RendererWrapper.map(game.state.drivers.Player.mapBoth((function(t){return t.withPlayer(t.fromData(e).player)}),(function(t){return t.fromData(e)})))},client.State.playerDriverFromDataGlobal=function(e){return game.state.drivers.RendererWrapper.map(game.state.drivers.Player.mapSame((function(t){return game.network.PlayerState.fromDataGlobal(e).withBall(t.ball)})))},client.State.playerDriverHitAction=function(e,t){return game.state.drivers.RendererWrapper.map(game.state.drivers.Player.map((function(n){return n.hit(e,t)})))},client.State.prototype.nowS=function(){return game.timing.nowS(this.reference)},client.State.prototype.nowTicks=function(){return game.timing.nowTicks(this.reference)},client.State.prototype.driveEvents=function(){this.timeEvent.driveLast(this.trace)},client.State.prototype.run=function(){const e=this;var t=window.requestAnimationFrame((function n(i){const r=game.timing.msToTicks(i-e.reference);e.trace.drive(r),e.trace.render(r),t=window.requestAnimationFrame(n)}));return function(){window.cancelAnimationFrame(t)}},client.State.prototype.cameraDriver=function(){return this.trace.lastFrame().driver.driver.driver},client.State.prototype.arrowDriver=function(){return this.cameraDriver().driver.drivers.get("arrow")},client.State.prototype.insertTimeEvent=function(e){this.timeEvent.insert(this.trace.timeEventAfter(e))},client.State.prototype.frameActionEntries=function(e){return e.map(function(e){const t=client.State.playerDriverFromData(e)(this.playerDriver);return[t.driver.current.player.id,game.state.actions.constant(t)]}.bind(this)).sort(game.utility.collection.map.KEY_COMPARATOR)},client.State.prototype.frameAction=function(e,t,n){return game.state.drivers.Actioning.map(game.state.drivers.Camera.map(game.state.drivers.Multi.map(new Map([["players",client.State.tableTimestampsAction(e,t,new Map(this.frameActionEntries(n)))]]),game.state.drivers.Multi.OTHERS.KEEP,game.state.drivers.Multi.ORDERED.OTHERS_FIRST),game.utility.identity))},client.State.prototype.tableAddAction=function(e){return client.State.tableMapAction(new Map([[e.id,game.state.actions.missing(game.state.actions.constant(client.State.playerDriverWithPlayer(e)(this.playerDriver)))]]))},client.State.prototype.insertEnterAction=function(e,t){this.timeEvent.insert(new game.state.TimeEvent(e,game.state.drivers.Actioning.map(game.state.drivers.Camera.map(game.state.drivers.Multi.map(new Map([["players",this.tableAddAction(t)]]),game.state.drivers.Multi.OTHERS.KEEP,game.state.drivers.Multi.ORDERED.OTHERS_FIRST),game.utility.identity))))},client.State.prototype.insertLeaveAction=function(e,t){this.timeEvent.insert(new game.state.TimeEvent(e,game.state.drivers.Actioning.map(game.state.drivers.Camera.map(game.state.drivers.Multi.map(new Map([["players",client.State.tableRemoveAction(t)]]),game.state.drivers.Multi.OTHERS.KEEP,game.state.drivers.Multi.ORDERED.OTHERS_FIRST),game.utility.identity))))},client.State.prototype.insertFrameAction=function(e,t,n,i,r){this.prunerData.index=Math.max(this.prunerData.index,e),this.timeSync.insert(new game.state.TimeSync(e,t)),this.indexEvent.insert(new game.state.IndexEvent(e,this.frameAction(n,i,r)))},client.State.prototype.insertHitAction=function(e,t,n,i){this.timeEvent.insert(new game.state.TimeEvent(e,game.state.drivers.Actioning.map(game.state.drivers.Camera.map(game.state.drivers.Multi.map(new Map([["players",client.State.tableHitAction(t,n,i)]]),game.state.drivers.Multi.OTHERS.KEEP,game.state.drivers.Multi.ORDERED.OTHERS_FIRST),game.utility.identity))))},client.Controller.CAMERA_SENSITIVITY=.0025,client.Controller.CAMERA_TILT_RANGE=.4*Math.PI,client.Controller.ARROW_SENSITIVITY=.005,client.Controller.ARROW_THRESHOLD=.02,client.Controller.prototype.pushCameraAction=function(e){this.state.insertTimeEvent(game.state.drivers.Actioning.map(game.state.drivers.Camera.map(game.utility.identity,e)))},client.Controller.prototype.pushArrowAction=function(e){this.state.insertTimeEvent(game.state.drivers.Actioning.map(game.state.drivers.Camera.map(game.state.actions.dynamic(function(t){const n=t.drivers.get("players").driver.unconditionalDriver;return n.satisfied?game.state.drivers.Multi.map(new Map([["arrow",game.state.actions.ifExisting(function(t){return t.replace({length:e(n.conditionalDriver.drivers.get(this.connection.player.id).driver.current.ball)})}.bind(this))]]),game.state.drivers.Multi.OTHERS.KEEP,game.state.drivers.Multi.ORDERED.OTHERS_FIRST):game.utility.identity}.bind(this)),game.utility.identity)))},client.Controller.prototype.pushCameraArrowAction=function(e,t){this.state.insertTimeEvent(game.state.drivers.Actioning.map(game.state.actions.dynamic((function(n){const i=n.driver.drivers.get("arrow");return i&&null!=i.length?game.state.drivers.Camera.map(game.state.drivers.Multi.map(new Map([["arrow",function(e){return e.replace({length:t(i.length)})}]]),game.state.drivers.Multi.OTHERS.KEEP,game.state.drivers.Multi.ORDERED.OTHERS_FIRST),e.bind(null,i.length)):game.state.drivers.Camera.map(game.utility.identity,e.bind(null,null))}))))},client.Controller.prototype.pushBallAction=function(e,t){const n=this.state.trace.timeEventAfter(game.state.drivers.Actioning.map(game.state.drivers.Camera.map(game.state.drivers.Multi.map(new Map([["arrow",game.state.actions.ifExisting((function(e){return e.replace({length:null})}))],["players",client.State.tableMapAction(new Map([[this.connection.player.id,client.State.playerDriverHitAction(e,t)]]))]]),game.state.drivers.Multi.OTHERS.KEEP,game.state.drivers.Multi.ORDERED.OTHERS_FIRST),game.utility.identity)));this.state.timeEvent.insert(n),this.connection.procedureSocket.send(game.network.Procedure.TREE.GAME.HIT.SELF.bind(n.timestamp,e,t))},client.Controller.prototype.handleResize=function(){const e=this.gl.canvas.clientWidth*window.devicePixelRatio,t=this.gl.canvas.clientHeight*window.devicePixelRatio;this.gl.canvas.width=e,this.gl.canvas.height=t,this.gl.viewport(0,0,e,t),this.pushCameraAction((function(n){return n.replace({ratio:e/t})}))},client.Controller.prototype.handleMouseMove=function(e){this.pushCameraArrowAction((function(t,n){return n.replace({pan:game.utility.modPositive(n.pan+client.Controller.CAMERA_SENSITIVITY*e.movementX,2*Math.PI),tilt:null==t?game.utility.clamp(n.tilt+client.Controller.CAMERA_SENSITIVITY*e.movementY,-client.Controller.CAMERA_TILT_RANGE,client.Controller.CAMERA_TILT_RANGE):n.tilt})}),(function(t){return game.utility.clamp(t-client.Controller.ARROW_SENSITIVITY*e.movementY,0,1)}))},client.Controller.prototype.handleWheel=function(e){this.pushCameraAction((function(t){return t.replace({zoom:game.utility.clamp(t.zoom*Math.pow(1.002,e.deltaY),.2,5)})}))},client.Controller.prototype.handleLockedClick=function(e){if(2==e.button){this.state.driveEvents();const e=this.state.arrowDriver();e&&null!=e.length?this.pushArrowAction((function(e){return null})):document.exitPointerLock()}},client.Controller.prototype.handleLockedMouseDown=function(e){0==e.button&&this.pushArrowAction((function(e){if(e.isHittable())return 0}))},client.Controller.prototype.handleLockedMouseUp=function(e){if(0==e.button){this.state.driveEvents();const e=this.state.arrowDriver();if(e){const t=e.length;if(null!=t&&t>=client.Controller.ARROW_THRESHOLD)return void this.pushBallAction(this.state.cameraDriver().camera.pan,(t-client.Controller.ARROW_THRESHOLD)/(1-client.Controller.ARROW_THRESHOLD))}this.pushArrowAction((function(e){return null}))}},client.Controller.prototype.handleUnlockedClick=function(){this.gl.canvas.requestPointerLock({unadjustedMovement:!0}).catch((function(e){alert("Failed to acquire pointer lock. Try a different browser.")}))},client.Controller.prototype.handleLockChange=function(){document.pointerLockElement?this.registerLocked():this.unregisterLocked()},client.Controller.prototype.registerLocked=function(){const e=client.webgl.canvas();e.removeEventListener("click",this.unlockedClickHandler),e.addEventListener("mousemove",this.mouseMoveHandler),e.addEventListener("wheel",this.wheelHandler),e.addEventListener("click",this.lockedClickHandler),e.addEventListener("mousedown",this.lockedMouseDownHandler),e.addEventListener("mouseup",this.lockedMouseUpHandler)},client.Controller.prototype.unregisterLocked=function(){const e=client.webgl.canvas();e.removeEventListener("mousemove",this.mouseMoveHandler),e.removeEventListener("wheel",this.wheelHandler),e.removeEventListener("click",this.lockedClickHandler),e.removeEventListener("mousedown",this.lockedMouseDownHandler),e.removeEventListener("mouseup",this.lockedMouseUpHandler),e.addEventListener("click",this.unlockedClickHandler)},client.Controller.prototype.register=function(){this.handleResize(),window.addEventListener("resize",this.resizeHandler),document.addEventListener("pointerlockchange",this.lockChangeHandler),client.webgl.canvas().addEventListener("click",this.unlockedClickHandler),document.pointerLockElement&&this.registerLocked()},client.Controller.prototype.unregister=function(){document.pointerLockElement&&this.unregisterLocked(),window.removeEventListener("resize",this.resizeHandler),document.removeEventListener("pointerlockchange",this.lockChangeHandler),client.webgl.canvas().removeEventListener("click",this.unlockedClickHandler)},client.Camera.GRAVITY=10,client.Camera.prototype.replace=function(e){const t=game.utility.mergeObjects([this,e]);return new client.Camera(t.position,t.pan,t.tilt,t.zoom,t.ratio)},client.Camera.prototype.follow=function(e,t){return this.replace({position:e.interpolate(this.position,Math.exp(-t*client.Camera.GRAVITY))})},client.Camera.prototype.matrix=function(){return game.geometry.Matrix.translation(this.position.negate()).dot(game.geometry.Matrix.rotationZ(-this.pan)).dot(game.geometry.Matrix.rotationX(-this.tilt-Math.PI/2)).dot(game.geometry.Matrix.translation(new game.geometry.Vector(0,0,1).multiply(25*this.zoom))).dot(game.geometry.Matrix.projection(this.ratio,1,1,2e4))},client.params.matchBoolean("trackListeners")){function countEventListeners(){return game.utility.collection.values(Node._listeners).map((function(e){return e._listeners.size})).reduce((function(e,t){return e+t}),0)}Node._listeners=new Set,Node.prototype._addEventListener=Node.prototype.addEventListener,Node.prototype.addEventListener=function(e,t,n){this._addEventListener(e,t,n),this._listeners||(this._listeners=new Map,game.utility.collection.set.addNew(Node._listeners,this)),game.utility.assert(!this._listeners.has(e),"Listener for type already exists"),this._listeners.set(e,t)},Node.prototype._removeEventListener=Node.prototype.removeEventListener,Node.prototype.removeEventListener=function(e,t,n){this._removeEventListener(e,t,n),game.utility.assert(this._listeners,"There are no listeners to remove"),game.utility.assert(this._listeners.has(e),"There is no listener of the given type"),game.utility.assert(this._listeners.get(e)===t,"Different listener for the given type"),this._listeners.delete(e),0==this._listeners.size&&(delete this._listeners,game.utility.collection.set.deleteExisting(Node._listeners,this))}}window.addEventListener("load",client.load);